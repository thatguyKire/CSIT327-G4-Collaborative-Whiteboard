{% extends "core/base.html" %}
{% load static %}
{% block title %}Teacher Dashboard - COLLABoard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard-shared.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<section class="dashboard-section">
  <h1>Welcome, {{ user.username }}</h1>
  <p class="subtitle">Manage your classes, monitor sessions, and interact with your students.</p>

  <div class="dashboard-grid">

    <!-- My Classes -->
    <div class="card">
      <h3>My Classes</h3>
      <p class="active-class-text">
        You currently have
        <span class="active-class-count">{{ active_classes_count }}</span>
        {% if active_classes_count == 1 %}active class{% else %}active classes{% endif %}
      </p>
    </div>

    <!-- Active Sessions -->
    <div class="card">
      <h3>Active Sessions</h3>
      {% if open_sessions %}
        <ul class="session-list">
          {% for session in open_sessions %}
            <li class="session-row">
              <div>
                <strong>{{ session.title|default:"Untitled Session" }}</strong>
                <div class="session-meta">Code: {{ session.code|default:"—" }}</div>
              </div>
              <div class="session-actions">
                <a href="{% url 'whiteboard' session.id %}" class="btn btn-primary">Join Whiteboard</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty-state"><p>No active sessions right now.</p></div>
      {% endif %}
      <div class="card-footer" style="margin-top:16px;">
        <a href="{% url 'session_list' %}" class="btn">Manage Sessions</a>
      </div>
    </div>

    <!-- Student Performance -->
    <div class="card" style="grid-column: span 2;">
      <h3>Student Performance</h3>
      <p class="small muted">Realtime participation metrics (strokes, uploads, active time).</p>

      <!-- Summary badges -->
      <div class="perf-summary">
        <div class="perf-badge">
          <span class="label">Total Students</span>
          <span class="value">{{ performance_totals.total_students }}</span>
        </div>
        <div class="perf-badge">
          <span class="label">Active Today</span>
          <span class="value">{{ performance_totals.active_today }}</span>
        </div>
        <div class="perf-badge">
          <span class="label">Total Strokes</span>
          <span class="value">{{ performance_totals.total_strokes }}</span>
        </div>
        <div class="perf-badge">
          <span class="label">Uploads</span>
          <span class="value">{{ performance_totals.total_uploads }}</span>
        </div>
      </div>

      <div id="teacherPerformanceGraph" class="graph-host" style="min-height:320px; margin-top:18px;">
        Loading performance graph...
      </div>

      <table class="perf-table">
        <thead>
          <tr>
            <th>Student</th>
            <th>Strokes</th>
            <th>Uploads</th>
            <th>Last Active</th>
          </tr>
        </thead>
        <tbody>
          {% for row in performance_rows %}
          <tr>
            <td>{{ row.username }}</td>
            <td>{{ row.strokes }}</td>
            <td>{{ row.uploads }}</td>
            <td>{{ row.last_active|default:"—" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">No data yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</section>

{{ performance_chart|json_script:"teacher_perf_data" }}

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{% static 'dashboard/js/teacher_performance_chart.js' %}"></script>
{% endblock %}
