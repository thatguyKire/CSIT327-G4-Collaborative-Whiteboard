{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'session/css/session_list.css' %}">
{% endblock %}

{% block title %}Manage Sessions - COLLABoard{% endblock %}

{% block content %}
<div class="main">
  <section class="dashboard-wrapper">
    <h1>Manage Sessions</h1>

    <!-- ✅ Search bar -->
    <form method="get" class="search-form">
      <input type="text" name="q" placeholder="Search sessions..." value="{{ query }}">
      <button type="submit" class="btn">Search</button>
      {% if query %}
        <a href="{% url 'session_list' %}" class="btn btn-secondary clear-btn">Clear</a>
      {% endif %}
    </form>

    <!-- Back to teacher dashboard -->
    <a href="{% url 'teacher_dashboard' %}" class="btn btn-secondary back-btn" aria-label="Back to dashboard">← Back</a>

    <!-- Create session -->
    <form method="post" action="{% url 'create_session' %}" class="create-session-form">
      {% csrf_token %}
      <input type="text" name="title" placeholder="Session Title" required>
      <button type="submit" class="btn">Create Session</button>
    </form>

    <!-- Flash messages -->
    {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li class="message {{ message.tags }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <!-- Sessions -->
    <h3>Your Sessions</h3>
    <ul class="session-list">
      {% for s in sessions %}
        <li class="session-item">
          <div class="session-meta">
            <strong>{{ s.title|default:"Untitled Session" }}</strong> — Code: <strong>{{ s.code }}</strong>
          </div>

          <div class="session-actions">
            <a href="{% url 'whiteboard' s.id %}" class="btn">Open</a>

            {% if s.is_offline_available %}
            <a href="{% url 'offline_view' s.id %}" class="btn btn-secondary">View Offline</a>
            {% else %}
              <button class="btn btn-secondary" disabled title="No offline snapshot yet">Offline Unavailable</button>
{% endif %}

            <!-- Invite -->
            <button type="button"
                    class="btn btn-secondary qr-btn"
                    data-qr-url="{% url 'session_qr' s.id %}"
                    data-session-code="{{ s.code|default:'' }}">
              Invite
            </button>

            <form method="post" action="{% url 'delete_session' s.id %}" class="inline delete-session-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        </li>
      {% empty %}
        <li class="no-session">No sessions yet.</li>
      {% endfor %}
    </ul>
  </section>
</div>

<!-- QR Modal -->
<div id="qrModal" class="qr-modal" aria-hidden="true">
  <div class="qr-modal-content">
    <div class="qr-modal-header">
      <strong>Invite Students</strong>
      <button id="qrClose" class="btn btn-secondary close-btn" aria-label="Close QR">Close</button>
    </div>

    <div class="qr-modal-body">
      <img id="qrImage" src="" alt="QR code" class="qr-image" />
      <div class="qr-code-row">
        <input id="qrCodeInput" type="text" readonly>
        <button id="copyCodeBtn" class="btn">Copy</button>
      </div>
      <p class="qr-hint">Students can scan the QR or use the code to join.</p>
    </div>
  </div>
</div>

<script src="{% static 'session/js/session_list.js' %}"></script>
<script src="{% static 'session/js/session_qr.js' %}"></script>
{% endblock %}
